@startuml
' Título do Diagrama
title Verificação de Assinatura e Limites de Plano

' Configurações de Aparência para um visual mais limpo e moderno
!theme vibrant
skinparam sequence {
    ArrowColor #555555
    ActorBorderColor #555555
    LifeLineBorderColor #555555
    ParticipantBorderColor #555555
    BoxBorderColor #555555
    
    ParticipantBackgroundColor #F8F8F8
    ActorBackgroundColor #EFEFEF
}
skinparam roundcorner 10
skinparam shadowing false
autonumber

' Declaração dos Participantes com cores distintas para fácil identificação
participant "API\n(Django REST)" as API #DDEEFF
participant "Middleware\nde Assinatura" as Middleware #FFDDDD
participant "Banco de Dados" as DB #FFEECC
participant "App" as App #DDFFDD

' Início do Fluxo
API -> Middleware: Requisição para endpoint protegido
activate Middleware #lightcoral

== Verificação de Assinatura ==

Middleware -> DB: Busca assinatura ativa do usuário
activate DB #lightyellow
DB --> Middleware: Retorna dados da assinatura e plano
deactivate DB

' Bloco Alternativo: Assinatura Ativa vs. Inativa
alt #E6FFE6 Assinatura Ativa

    Middleware -> DB: Verifica uso atual vs limites do plano
    activate DB #lightyellow
    DB --> Middleware: Resultado da verificação
    deactivate DB
    
    note right of Middleware
        Compara:
        - Transações utilizadas vs limite
        - Empresas cadastradas vs limite
        - Funcionalidades ativas vs plano
    end note
    
    alt #E6F7FF Dentro dos Limites
        Middleware --> API: Permite acesso
        deactivate Middleware
        API -> API: Processa requisição normalmente
    else #FFF0E6 Limite Excedido
        Middleware --> API: Bloqueia acesso (403 Forbidden)
        deactivate Middleware
        API --> App: Retorna erro de limite
        note left of App
            Usuário deve fazer upgrade
            do plano para continuar
        end note
    end

else #FFE6E6 Assinatura Inativa/Cancelada

    Middleware --> API: Bloqueia acesso (402 Payment Required)
    deactivate Middleware
    API --> App: Retorna erro de assinatura
    note left of App
        Usuário deve reativar
        ou assinar um plano
    end note

end

@enduml