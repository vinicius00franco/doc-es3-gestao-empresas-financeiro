//================================//
//     MODELAGEM DE DADOS (v7)    //
//   Layout Guiado por Grupos     //
//================================//

Project financas_app {
  database_type: 'PostgreSQL'
  Note: 'Modelagem de dados para um aplicativo de finanças empresariais.'
}

// --- GRUPOS DE TABELAS PARA ORGANIZAÇÃO VISUAL ---
// Instruções para a ferramenta de renderização agrupar tabelas relacionadas.

TableGroup Grupo_Usuarios {
  usuarios
  configuracoes_usuario
  tokens_recuperacao
  logs_atividade
}

TableGroup Grupo_Assinaturas {
  planos
  assinaturas
}

TableGroup Grupo_Financeiro {
  empresas
  categorias
  transacoes
  anexos_transacao
}


// --- ENUMS GLOBAIS ---

enum status_assinatura {
  ativa
  cancelada
  inadimplente
  expirada
}
enum tipo_empresa {
  MEI
  ME
  EPP
  LTDA
  SA
}
enum tipo_transacao_categoria {
  entrada
  saida
  ambos
}
enum tipo_transacao {
  entrada
  saida
}
enum status_transacao {
  pendente
  confirmada
  cancelada
}
enum forma_pagamento {
  dinheiro
  pix
  cartao_credito
  cartao_debito
  boleto
  transferencia
}
enum frequencia_recorrencia {
  semanal
  mensal
  bimestral
  trimestral
  semestral
  anual
}
enum tema_usuario {
  claro
  escuro
  auto
}
enum formato_data_usuario {
  "DD/MM/YYYY"
  "MM/DD/YYYY"
  "YYYY-MM-DD"
}


//================================//
//        ESTRUTURA LÓGICA        //
//================================//


// --- NÚCLEO DO USUÁRIO ---
// Tabelas centrais de autenticação e configuração do usuário.

Table usuarios {
  id integer [pk, increment]
  nome varchar(255) [not null, note: 'Nome completo do usuário']
  email varchar(255) [unique, not null, note: 'Email único para login']
  senha_hash varchar(255) [not null, note: 'Senha hasheada com bcrypt']
  criado_em timestamp [default: `now()`, note: 'Data de criação da conta']
  atualizado_em timestamp [default: `now()`, note: 'Última atualização do perfil']
  ativo boolean [default: true, note: 'Conta ativa/inativa']
  
  indexes {
    email [unique]
  }
}

Table configuracoes_usuario {
  id integer [pk, increment]
  usuario_id integer [unique, not null]
  tema tema_usuario [default: 'auto']
  moeda varchar(3) [default: 'BRL', note: 'Código ISO da moeda']
  formato_data formato_data_usuario [default: '"DD/MM/YYYY"']
  fuso_horario varchar(50) [default: 'America/Sao_Paulo']
  notificacoes_email boolean [default: true]
  notificacoes_push boolean [default: true]
  backup_automatico boolean [default: false]
  criado_em timestamp [default: `now()`]
  atualizado_em timestamp [default: `now()`]
  
  indexes {
    usuario_id [unique]
  }
}

Table tokens_recuperacao {
  id integer [pk, increment]
  usuario_id integer [not null]
  token varchar(255) [unique, not null]
  usado boolean [default: false]
  expira_em timestamp [not null]
  criado_em timestamp [default: `now()`]
  
  indexes {
    token [unique]
    usuario_id
    expira_em
  }
  Note: 'Regra: O token de recuperação deve ter uma validade mínima (expira_em > criado_em).'
}

Table logs_atividade {
  id integer [pk, increment]
  usuario_id integer [not null]
  acao varchar(100) [not null, note: 'Tipo da ação (login, logout, criar_transacao, etc)']
  detalhes json [note: 'Detalhes da ação em JSON']
  ip_address varchar(45) [note: 'IP do usuário (IPv4 ou IPv6)']
  user_agent text [note: 'User agent do navegador/app']
  criado_em timestamp [default: `now()`]
  
  indexes {
    usuario_id
    acao
    criado_em
    (usuario_id, criado_em) [note: 'Histórico por usuário']
  }
}


// --- ASSINATURAS E PLANOS ---
// Tabelas relacionadas ao modelo de negócio e subscrições.

Table planos {
  id integer [pk, increment]
  nome varchar(50) [unique, not null, note: 'Nome do plano (ex: Grátis, Pro)']
  descricao text [note: 'Descrição detalhada do plano']
  preco decimal(10, 2) [not null, note: 'Preço mensal do plano']
  limite_transacoes integer [note: 'Limite de transações por mês (null = ilimitado)']
  limite_empresas integer [note: 'Limite de empresas cadastradas (null = ilimitado)']
  permite_relatorios boolean [default: false, note: 'Permite acesso a relatórios avançados']
  permite_exportacao boolean [default: false, note: 'Permite exportação de dados']
  ativo boolean [default: true, note: 'Plano disponível para contratação']
  criado_em timestamp [default: `now()`]
  
  indexes {
    nome [unique]
    ativo
  }
}

Table assinaturas {
  id integer [pk, increment]
  usuario_id integer [unique, not null, note: 'Um usuário tem uma assinatura ativa']
  plano_id integer [not null]
  status status_assinatura [not null, default: 'ativa']
  data_inicio date [not null, note: 'Data de início da assinatura']
  data_fim date [note: 'Data de término (null para assinaturas ativas)']
  valor_pago decimal(10, 2) [note: 'Valor efetivamente pago']
  gateway_pagamento varchar(50) [note: 'Gateway usado (Stripe, PayPal, etc)']
  id_transacao_gateway varchar(255) [note: 'ID da transação no gateway']
  criado_em timestamp [default: `now()`]
  atualizado_em timestamp [default: `now()`]
  
  indexes {
    usuario_id [unique]
    status
    (data_inicio, data_fim)
  }
  Note: 'Regra: A data de término (data_fim) deve ser posterior à data de início (data_inicio) se não for nula.'
}


// --- NÚCLEO DE NEGÓCIO (EMPRESAS E TRANSAÇÕES) ---
// Fluxo principal da aplicação: Empresas, suas categorias e transações.

Table empresas {
  id integer [pk, increment]
  usuario_id integer [not null]
  cnpj varchar(18) [unique, not null, note: 'CNPJ formatado XX.XXX.XXX/XXXX-XX']
  razao_social varchar(255) [not null, note: 'Razão social da empresa']
  nome_fantasia varchar(255) [note: 'Nome fantasia da empresa']
  tipo_empresa tipo_empresa [not null]
  ativa boolean [default: true, note: 'Empresa ativa para o usuário']
  empresa_padrao boolean [default: false, note: 'Empresa selecionada por padrão']
  criado_em timestamp [default: `now()`]
  atualizado_em timestamp [default: `now()`]
  
  indexes {
    cnpj [unique]
    usuario_id
    ativa
    (usuario_id, empresa_padrao) [note: 'Apenas uma empresa padrão por usuário']
  }
  Note: 'Regra: Apenas uma empresa pode ser marcada como padrão por usuário.'
}

Table categorias {
  id integer [pk, increment]
  empresa_id integer [not null]
  nome varchar(100) [not null, note: 'Nome da categoria']
  descricao text [note: 'Descrição detalhada da categoria']
  cor varchar(7) [note: 'Cor hex para UI (#FFFFFF)']
  icone varchar(50) [note: 'Nome do ícone para UI']
  tipo_transacao tipo_transacao_categoria [not null, default: 'ambos']
  ativa boolean [default: true]
  categoria_padrao boolean [default: false, note: 'Categoria padrão para o tipo']
  criado_em timestamp [default: `now()`]
  
  indexes {
    empresa_id
    tipo_transacao
    ativa
    (empresa_id, nome) [unique, note: 'Nome único por empresa']
  }
}

Table transacoes {
  id integer [pk, increment]
  empresa_id integer [not null]
  categoria_id integer [note: 'Categoria opcional']
  descricao varchar(255) [not null, note: 'Descrição da transação']
  valor decimal(12, 2) [not null, note: 'Valor da transação (sempre positivo)']
  data_transacao date [not null, note: 'Data da transação']
  tipo_transacao tipo_transacao [not null]
  status status_transacao [default: 'confirmada']
  observacoes text [note: 'Observações adicionais']
  numero_documento varchar(100) [note: 'Número do documento/nota fiscal']
  forma_pagamento forma_pagamento [note: 'Forma de pagamento']
  recorrente boolean [default: false, note: 'Transação recorrente']
  frequencia_recorrencia frequencia_recorrencia [note: 'Frequência se recorrente']
  criado_em timestamp [default: `now()`]
  atualizado_em timestamp [default: `now()`]
  
  indexes {
    empresa_id
    data_transacao
    tipo_transacao
    status
    categoria_id
    (empresa_id, data_transacao)
    (data_transacao, tipo_transacao)
  }
  Note: 'Regras de negócio: Valor sempre positivo e data da transação não pode ser futura.'
}

Table anexos_transacao {
  id integer [pk, increment]
  transacao_id integer [not null]
  nome_arquivo varchar(255) [not null]
  tipo_arquivo varchar(50) [not null, note: 'MIME type do arquivo']
  tamanho_arquivo integer [not null, note: 'Tamanho em bytes']
  caminho_arquivo varchar(500) [not null, note: 'Caminho no storage']
  criado_em timestamp [default: `now()`]
  
  indexes {
    transacao_id
  }
}


// --- RELACIONAMENTOS (ÚNICA FONTE DA VERDADE) ---

// Usuário
Ref: configuracoes_usuario.usuario_id > usuarios.id [delete: cascade]
Ref: tokens_recuperacao.usuario_id > usuarios.id [delete: cascade]
Ref: logs_atividade.usuario_id > usuarios.id [delete: cascade]

// Assinaturas
Ref: assinaturas.usuario_id > usuarios.id [delete: cascade]
Ref: assinaturas.plano_id > planos.id [delete: restrict]

// Negócio
Ref: empresas.usuario_id > usuarios.id [delete: cascade]
Ref: categorias.empresa_id > empresas.id [delete: cascade]
Ref: transacoes.empresa_id > empresas.id [delete: cascade]
Ref: transacoes.categoria_id > categorias.id [delete: set null]
Ref: anexos_transacao.transacao_id > transacoes.id [delete: cascade]