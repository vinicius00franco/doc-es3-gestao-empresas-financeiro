@startuml
!theme plain
title Diagrama de Caso de Uso - API Gestão Financeira (Atualizado)

skinparam linetype ortho
skinparam backgroundColor #F6F9FC
skinparam shadowing false
skinparam defaultFontName "Arial"
skinparam defaultFontSize 12
skinparam ArrowColor #2F4858
skinparam ArrowThickness 1.1
skinparam actorStyle awesome
skinparam usecase {
  BackgroundColor #FFFFFF
  BorderColor #2F4858
  FontColor #0F2E3D
}
skinparam package {
  BackgroundColor #E8F1FA
  BorderColor #2F4858
}
skinparam titleFontSize 20
skinparam titleFontColor #1F4E79
skinparam packageSpacing 50
skinparam usecaseSpacing 25
skinparam actorSpacing 20
left to right direction

together {
actor "Usuário" as User <<primary>>
actor "Sistema de Pagamento" as PaymentSystem <<external>>
}

actor "Receita Federal" as ReceitaFederal <<external>>

rectangle "Sistema de Gestão Financeira" {
  
  package "Autenticação" {
    usecase "Fazer Login" as UC1
    usecase "Registrar Usuário" as UC2
    usecase "Recuperar Senha" as UC3
    usecase "Gerenciar Configurações" as UC4
  }
  
  package "Gestao de Empresas (Multi-tenant)" {
    usecase "Cadastrar Empresa\n(empr_app_id)" as UC5
    usecase "Editar Empresa\n(empr_id)" as UC6
    usecase "Definir Empresa Padrao\n(empr_padrao)" as UC7
    usecase "Listar Empresas\n(por usua_id)" as UC8
  }
  
  package "Gestao Financeira (Tenant-aware)" {
    usecase "Criar Transacao\n(tran_app_id)" as UC9
    usecase "Editar Transacao\n(tran_id)" as UC10
    usecase "Excluir Transacao\n(tran_id)" as UC11
    usecase "Listar Transacoes\n(por tran_app_id)" as UC12
    usecase "Gerenciar Categorias\n(cate_app_id)" as UC13
    usecase "Gerenciar Fornecedores\n(forn_app_id)" as UC14
  }
  
  package "Agenda & Alertas" {
    usecase "Agendar Contas a Pagar/Receber" as UC26
    usecase "Projeção de Saldo Diário" as UC27
    usecase "Configurar Alertas" as UC28
  }
  
  package "Processamento Fiscal (Particionado)" {
    usecase "Upload Nota Fiscal\n(notf_app_id)" as UC15
    usecase "Processar XML/PDF\n(notf_arquivo)" as UC16
    usecase "Extrair Dados NF-e\n(notf_dados_extraidos)" as UC17
    usecase "Criar Transacao da NF\n(tran_app_id)" as UC18
  }
  
  package "Assinaturas (Global)" {
    usecase "Contratar Plano\n(plan_id)" as UC19
    usecase "Alterar Plano\n(assi_id)" as UC20
    usecase "Cancelar Assinatura\n(assi_status)" as UC21
    usecase "Verificar Limites\n(plan_limite_*)" as UC22
  }
  
  package "Dashboard e Relatorios (Tenant-Aware)" {
    usecase "Visualizar Dashboard\n(filtrado por app_id)" as UC23
    usecase "Gerar Relatorios\n(por tenant)" as UC24
    usecase "Exportar Dados\n(isolado por tenant)" as UC25
  }
}

' Relacionamentos do Usuário
User --> UC1
User --> UC2
User --> UC3
User --> UC4
User --> UC5
User --> UC6
User --> UC7
User --> UC8
User --> UC9
User --> UC10
User --> UC11
User --> UC12
User --> UC13
User --> UC14
User --> UC15
User --> UC16
User --> UC18
User --> UC19
User --> UC20
User --> UC21
User --> UC23
User --> UC24
User --> UC25
User --> UC26
User --> UC27
User --> UC28

' Relacionamentos do Sistema de Pagamento
PaymentSystem --> UC19
PaymentSystem --> UC20
PaymentSystem --> UC21

' Relacionamentos da Receita Federal
ReceitaFederal --> UC17

' Relacionamentos internos
UC16 --> UC17 : <<include>>
UC17 --> UC18 : <<extend>>
UC9 --> UC22 : <<include>>
UC5 --> UC22 : <<include>>
UC24 --> UC22 : <<include>>
UC25 --> UC22 : <<include>>
UC27 --> UC24 : <<include>>

legend right
<b>Legenda</b>\nActor <<primary>>: Usuário principal\nActor <<external>>: Sistema Externo\n<<include>> Dependência obrigatória\n<<extend>> Comportamento opcional
endlegend

@enduml