@startuml extract-data
title Extração de Dados da Nota Fiscal

participant "Queue Worker" as QW
participant "Invoice Service" as IS
participant "OCR Service" as OCR
participant "XML Parser" as XML
participant "Data Validator" as DV
database "Database" as DB

QW -> IS: Processar invoice da fila
IS -> IS: Identificar tipo (XML/PDF)

alt Arquivo XML
    IS -> XML: Extrair dados estruturados
    XML -> IS: Dados da NF-e
else Arquivo PDF
    IS -> OCR: Extrair texto/dados
    OCR -> IS: Dados extraídos
end

IS -> DV: Validar dados extraídos
DV -> IS: Dados validados

IS -> DB: Salvar dados extraídos
note right
  - CNPJ emissor/destinatário
  - Valores (total, impostos)
  - Itens/serviços
  - Data de emissão
  - Chave de acesso
end note

IS -> IS: Atualizar status: "processed"
IS -> QW: Enfileirar para análise

@enduml