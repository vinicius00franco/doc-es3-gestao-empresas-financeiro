@startuml analyze-and-categorize
title Análise e Categorização de Dados Fiscais

participant "Queue Worker" as QW
participant "Invoice Service" as IS
participant "Company Service" as CS
participant "Transaction Service" as TS
participant "Contact Service" as CNS
database "Database" as DB

QW -> IS: Processar análise da invoice
IS -> DB: Buscar dados extraídos

IS -> CS: Verificar empresa por CNPJ
alt Empresa não existe
    CS -> DB: Criar nova empresa
    CS -> IS: ID da nova empresa
else Empresa existe
    CS -> IS: ID da empresa existente
end

IS -> CNS: Verificar fornecedor/cliente
alt Contato não existe
    CNS -> DB: Criar novo contato
    CNS -> IS: ID do novo contato
else Contato existe
    CNS -> IS: ID do contato existente
end

IS -> TS: Criar transação financeira
note right
  - Tipo: receita/despesa
  - Valor total
  - Impostos
  - Categoria automática
  - Referência à NF-e
end note

TS -> DB: Salvar transação
IS -> DB: Atualizar status: "analyzed"
IS -> QW: Processo concluído

@enduml